<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Integralize — Дифференциалы</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .diffeq-formula-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 18px;
      margin-top: 23px;
      font-size: 1.16em;
      flex-wrap: wrap;
    }
    .diffeq-frac {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      font-size: 1em;
      font-weight: 500;
      margin-right: 3px;
      margin-left: 3px;
      line-height: 1;
      min-width: 28px;
    }
    .diffeq-frac-num {
      font-size: 0.98em;
      font-family: inherit;
      padding-bottom: 0.2em;
    }
    .diffeq-frac-bar {
      border-top: 2.1px solid #222;
      width: 21px;
      height: 0;
      margin: 0;
    }
    .diffeq-frac-den {
      font-size: 0.98em;
      font-family: inherit;
      padding-top: 0.2em;
    }
    .diffeq-eq {
      font-size: 1.18em;
      font-weight: 600;
      color: #4267e9;
      margin: 0 8px 0 8px;
    }
    .diffeq-f-input {
      width: 220px;
      font-size: 1em;
      padding: 7px 14px;
      border-radius: var(--radius);
      border: 1px solid #e3e6ee;
      margin-right: 10px;
      background: #fff;
      transition: border 0.2s;
    }
    .diffeq-f-input:focus {
      border: 1.5px solid #4267e9;
      outline: none;
    }
    .diffeq-ic {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 1em;
      color: #222;
    }
    .diffeq-ic input[type="number"] {
      width: 54px;
      font-size: 1em;
      margin: 0 3px;
      border-radius: 7px;
      border: 1px solid #e3e6ee;
      padding: 4px 7px;
      background: #fff;
      transition: border 0.2s;
    }
    .diffeq-ic input[type="number"]:focus {
      border: 1.5px solid #4267e9;
      outline: none;
    }
    @media (max-width: 650px) {
      .diffeq-formula-row {
        flex-direction: column;
        align-items: stretch;
        gap: 7px;
        font-size: 1em;
      }
      .diffeq-ic input[type="number"], .diffeq-f-input {
        width: 100%;
        min-width: 0;
        margin-right: 0;
        margin-left: 0;
      }
      .diffeq-ic {
        justify-content: flex-start;
      }
    }
    /* Остальной стиль графика и кнопок */
    #diffeq-graph-container {
      position: relative;
      width: 100%;
      max-width: 540px;
      margin: 0 auto 12px auto;
      height: 340px;
      background: linear-gradient(135deg, #e3f0ff 0%, #f8fafc 100%);
      border-radius: 15px;
      box-shadow: 0 4px 28px rgba(66,103,233,0.13);
      transition: box-shadow .2s;
      display: none;
      overflow: hidden;
    }
    #diffeq-graph-container.active {
      display: block;
      animation: fadeIn .7s;
    }
    #diffeq-graph {
      display: block;
      margin: 0 auto;
      background: transparent;
      border-radius: 12px;
      border: none;
      width: 100%;
      max-width: 540px;
      height: 340px;
      cursor: crosshair;
      transition: filter .2s;
      box-shadow: none;
    }
    .graph-tooltip {
      position: absolute;
      background: #fff;
      color: #222;
      font-size: 1em;
      border: 1.5px solid #4267e9;
      border-radius: 8px;
      padding: 3px 13px;
      pointer-events: none;
      box-shadow: 0 2px 12px rgba(66,103,233,0.15);
      z-index: 4;
      white-space: nowrap;
      transition: opacity 0.13s;
      opacity: 0;
      font-family: inherit;
    }
    .center-btn-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 13px;
      margin-bottom: 5px;
      flex-wrap: wrap;
    }
    .step-btn {
      background: #e3e6ee;
      color: #a0a6b8;
      border: none;
      padding: 10px 24px;
      border-radius: var(--radius);
      font-size: 1.09em;
      font-weight: 600;
      cursor: not-allowed;
      box-shadow: 0 1px 8px rgba(66,103,233,0.07);
      opacity: .68;
      transition: none;
      pointer-events: none;
      user-select: none;
    }
    #diffeq-result {
      margin-top: 0;
      min-height: 0;
      transition: min-height .3s;
      padding-bottom: 0;
      display: none;
      justify-content: center;
      align-items: flex-start;
    }
    #diffeq-result.active {
      display: flex;
      min-height: 56px;
      padding-bottom: 14px;
      animation: fadeIn .6s;
    }
    @keyframes fadeIn {
      0% {opacity:0; transform:translateY(30px);}
      100% {opacity:1; transform:translateY(0);}
    }
    @media (max-width: 650px) {
      #diffeq-graph-container, #diffeq-graph { max-width: 98vw; }
      .center-btn-row { flex-direction: column; gap: 7px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/static/images/logo.svg" alt="Integralize Logo" />
      <span>Integralize</span>
    </div>
    <nav class="topnav">
      <a href="/">Главная</a>
      <a href="/integrals">Интегралы</a>
      <a href="/diffeq" class="active">Дифференциалы</a>
      <a href="/models">Модели</a>
    </nav>
  </header>
  <main>
    <section class="hero">
      <h1>Численное решение дифференциальных уравнений</h1>
      <form id="diffeq-form" autocomplete="off">
        <div class="diffeq-formula-row">
          <span class="diffeq-frac">
            <span class="diffeq-frac-num">dy</span>
            <span class="diffeq-frac-bar"></span>
            <span class="diffeq-frac-den">dx</span>
          </span>
          <span class="diffeq-eq">=</span>
          <input type="text" name="expression" required placeholder="f(x, y)" class="diffeq-f-input" autocomplete="off">
          <span class="diffeq-ic">
            y(
            <input type="number" name="x0" step="any" value="0" required placeholder="x₀">
            ) =
            <input type="number" name="y0" step="any" value="1" required placeholder="y₀">
          </span>
        </div>
        <div class="diffeq-row">
          <label for="diffeq-tMax" class="diffeq-label">Максимальное x:</label>
          <div class="integral-field-wrap">
            <input type="number" id="diffeq-tMax" name="tMax" step="any" value="10" required placeholder="10">
          </div>
        </div>
        <div class="diffeq-row">
          <label for="diffeq-h" class="diffeq-label">Шаг:</label>
          <div class="integral-field-wrap">
            <input type="number" id="diffeq-h" name="h" step="any" value="0.4" required placeholder="0.4">
          </div>
        </div>
        <div class="diffeq-row">
          <label for="diffeq-method" class="method-label">Методы:</label>
          <div class="integral-field-wrap">
            <select name="method" id="diffeq-method">
              <option value="euler">Эйлер</option>
              <option value="runge-kutta">Рунге-Кутта</option>
            </select>
          </div>
        </div>
        <div class="center-btn-row">
          <button type="submit">Решить</button>
          <button type="button" class="step-btn" tabindex="-1">Пошаговое решение</button>
        </div>
      </form>
      <div id="diffeq-result"></div>
      <div id="diffeq-graph-container">
        <canvas id="diffeq-graph" width="540" height="340"></canvas>
        <div class="graph-tooltip" id="graph-tooltip"></div>
      </div>
    </section>
  </main>
  <footer>
    <span>&copy; 2025 Integralize</span>
  </footer>
  <script>
    // Улучшенный график
    function drawGraph(X, Y) {
      const container = document.getElementById('diffeq-graph-container');
      const canvas = document.getElementById('diffeq-graph');
      const tooltip = document.getElementById('graph-tooltip');
      container.classList.add('active');
      canvas.style.display = 'block';

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Очистка и проверка
      let clean = [];
      for (let i = 0; i < X.length; i++) {
        if (isFinite(X[i]) && isFinite(Y[i])) clean.push([X[i], Y[i]]);
      }
      if (clean.length < 2) return;
      X = clean.map(p => p[0]);
      Y = clean.map(p => p[1]);

      // Масштаб
      const W = canvas.width, H = canvas.height;
      const YLIMIT = 1e6;
      let maxYabs = Math.max(...Y.map(y => Math.abs(y)));
      let filtered = Y;
      if (maxYabs > YLIMIT) {
        filtered = Y.map(y => Math.abs(y) > YLIMIT ? Math.sign(y) * YLIMIT : y);
      }
      let minX = Math.min(...X), maxX = Math.max(...X);
      let minY = Math.min(...filtered), maxY = Math.max(...filtered);
      let pad = 0.10;
      minX -= (maxX - minX) * pad; maxX += (maxX - minX) * pad;
      minY -= (maxY - minY) * pad; maxY += (maxY - minY) * pad;
      if (minY === maxY) { minY -= 1; maxY += 1; }
      if (minX === maxX) { minX -= 1; maxX += 1; }
      function sx(x) { return 55 + (x - minX) / (maxX - minX) * (W - 90); }
      function sy(y) { return H - 40 - (y - minY) / (maxY - minY) * (H - 70); }

      // Градиент под графиком
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(sx(X[0]), sy(filtered[0]));
      for (let i = 1; i < X.length; i++) {
        ctx.lineTo(sx(X[i]), sy(filtered[i]));
      }
      ctx.lineTo(sx(X[X.length - 1]), H - 40);
      ctx.lineTo(sx(X[0]), H - 40);
      ctx.closePath();
      let grad = ctx.createLinearGradient(0, sy(Math.max(...filtered)), 0, H - 40);
      grad.addColorStop(0, "rgba(66,103,233,0.18)");
      grad.addColorStop(1, "rgba(66,103,233,0.01)");
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.restore();

      // Сетка
      ctx.save();
      ctx.strokeStyle = "#d5e0f7";
      ctx.lineWidth = 1;
      ctx.setLineDash([2, 10]);
      let gridCountX = 5, gridCountY = 6;
      for (let i = 0; i <= gridCountX; i++) {
        let x = minX + (maxX - minX) * i / gridCountX;
        let px = sx(x);
        ctx.beginPath(); ctx.moveTo(px, 35); ctx.lineTo(px, H - 30); ctx.stroke();
      }
      for (let i = 0; i <= gridCountY; i++) {
        let y = minY + (maxY - minY) * i / gridCountY;
        let py = sy(y);
        ctx.beginPath(); ctx.moveTo(55, py); ctx.lineTo(W - 35, py); ctx.stroke();
      }
      ctx.setLineDash([]);
      ctx.restore();

      // Оси
      ctx.save();
      ctx.strokeStyle = "#4267e9";
      ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.moveTo(sx(minX), sy(0)); ctx.lineTo(sx(maxX), sy(0)); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(sx(0), sy(minY)); ctx.lineTo(sx(0), sy(maxY)); ctx.stroke();
      ctx.restore();

      // Подписи делений
      ctx.save();
      ctx.fillStyle = "#4267e9";
      ctx.font = "bold 14px 'Inter', Arial, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for (let i = 0; i <= gridCountX; i++) {
        let x = minX + (maxX - minX) * i / gridCountX;
        let px = sx(x);
        ctx.fillText(Number(x.toFixed(2)), px, H - 25);
      }
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      for (let i = 0; i <= gridCountY; i++) {
        let y = minY + (maxY - minY) * i / gridCountY;
        let py = sy(y);
        ctx.fillText(Number(y.toFixed(2)), 50, py);
      }
      ctx.restore();

      // График кривой (плавный)
      ctx.save();
      ctx.strokeStyle = "#4267e9";
      ctx.lineWidth = 3.3;
      ctx.beginPath();
      ctx.moveTo(sx(X[0]), sy(filtered[0]));
      for (let i = 1; i < X.length; i++) {
        const xc = (sx(X[i - 1]) + sx(X[i])) / 2;
        const yc = (sy(filtered[i - 1]) + sy(filtered[i])) / 2;
        ctx.quadraticCurveTo(sx(X[i - 1]), sy(filtered[i - 1]), xc, yc);
      }
      ctx.lineTo(sx(X[X.length - 1]), sy(filtered[X.length - 1]));
      ctx.stroke();
      ctx.restore();

      // Точки
      ctx.save();
      for (let i = 0; i < X.length; i++) {
        ctx.beginPath();
        ctx.arc(sx(X[i]), sy(filtered[i]), 6, 0, 2 * Math.PI);
        ctx.fillStyle = "#4adedb";
        ctx.shadowColor = "#4267e9";
        ctx.shadowBlur = 7;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 1.5;
        ctx.stroke();
      }
      ctx.restore();

      // Наведение на точки — с учетом границ canvas
      const points = X.map((x, i) => ({
        x: sx(x),
        y: sy(filtered[i]),
        origX: x,
        origY: filtered[i],
        idx: i
      }));

      canvas.onmousemove = function (e) {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        let found = null;
        let minDist = 16;
        for (const pt of points) {
          const dx = pt.x - mx, dy = pt.y - my;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < minDist) {
            minDist = dist;
            found = pt;
          }
        }
        if (found) {
          tooltip.style.opacity = 1;
          tooltip.textContent = `x = ${Number(found.origX.toFixed(4))}, y = ${Number(found.origY.toFixed(4))}`;

          // Вычисление размеров и корректировка положения
          const tooltipRect = tooltip.getBoundingClientRect();
          const canvasRect = canvas.getBoundingClientRect();

          let left = found.x + canvas.offsetLeft + 18;
          let top = found.y + canvas.offsetTop - 20;

          const tooltipWidth = tooltipRect.width || 120;
          const tooltipHeight = tooltipRect.height || 30;

          // Правая граница
          if (left + tooltipWidth > canvas.width) left = canvas.width - tooltipWidth - 5;
          // Левая граница
          if (left < 0) left = 5;
          // Верхняя граница
          if (top < 0) top = 5;
          // Нижняя граница
          if (top + tooltipHeight > canvas.height) top = canvas.height - tooltipHeight - 5;

          tooltip.style.left = left + "px";
          tooltip.style.top = top + "px";
        } else {
          tooltip.style.opacity = 0;
        }
      };
      canvas.onmouseleave = function () {
        tooltip.style.opacity = 0;
      };
    }

    document.getElementById('diffeq-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;
      const resultBlock = document.getElementById('diffeq-result');
      const container = document.getElementById('diffeq-graph-container');
      const canvas = document.getElementById('diffeq-graph');
      document.getElementById('graph-tooltip').style.opacity = 0;
      resultBlock.classList.remove('active');
      resultBlock.innerHTML = '';
      resultBlock.style.display = 'none';
      container.classList.remove('active');
      canvas.style.display = "none";

      const method = form.method.value;
      const expression = form.expression.value;
      const y0 = parseFloat(form.y0.value);
      const x0 = parseFloat(form.x0.value);
      const tMax = parseFloat(form.tMax.value);
      const h = parseFloat(form.h.value);

      const body = JSON.stringify({
        equationType: method,
        expression: expression,
        args: [y0, x0, tMax, h]
      });

      try {
        const response = await fetch('http://127.0.0.1:8080/api/differential', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body
        });
        const data = await response.json();
        const X = data.x || data.X;
        const Y = data.y || data.Y;
        if (Array.isArray(X) && Array.isArray(Y)) {
          resultBlock.classList.add('active');
          resultBlock.style.display = 'flex';
          resultBlock.innerHTML = '';
          drawGraph(X, Y);
        } else if (data && data.error) {
          resultBlock.classList.add('active');
          resultBlock.style.display = 'flex';
          resultBlock.innerHTML = `<div class="result error">${data.error}</div>`;
        } else {
          resultBlock.classList.add('active');
          resultBlock.style.display = 'flex';
          resultBlock.innerHTML = '<div class="result error">Не удалось получить результат.</div>';
        }
      } catch (err) {
        resultBlock.classList.add('active');
        resultBlock.style.display = 'flex';
        resultBlock.innerHTML = '<div class="result error">Ошибка соединения с сервером.</div>';
      }
    });
  </script>
</body>
</html>
